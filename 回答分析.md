# TP 超声断层扫描 - 问题分析与回答

## 第1部分：A-scan矩阵的设置和采集

### 问题1：请说明选择物体平移来实现A-scan的理由

**理论分析：**

选择平移物体而不是平移传感器的理由包括：

1. **机械简化**：使用点状探测器（单换能器）时,移动较小的物体比移动整个收发系统更简单、更精确
2. **几何稳定性**：固定探测器保证了发射器和接收器之间的对齐关系恒定,减少几何误差
3. **平行几何**：物体的平移确保了所有投影线保持平行,这是平行束断层扫描的基本要求
4. **成本效益**：移动物体的机械系统比移动整个超声探测系统更经济
5. **校准简便**：固定的换能器位置使系统校准更容易维护

---

### 问题2：凝胶有什么用？如果凝胶分布不均,可能会出现什么问题？

**理论分析：**

**凝胶的作用：**
1. **阻抗匹配**：超声凝胶的声阻抗介于换能器材料和水之间,减少声阻抗突变
2. **消除气隙**：填充换能器表面和水箱壁之间的微小空隙
3. **减少反射损失**：空气/固体界面会反射几乎全部超声能量(~99.9%),凝胶可将反射降低到最小
4. **提高耦合效率**：确保声能有效传输到水介质中

**凝胶分布不均的问题：**
1. **能量损失不均**：不同采集位置的信号强度会有非均匀衰减
2. **伪影产生**：局部声束畸变会在重建图像中产生伪影
3. **测量误差**：衰减系数的提取会出现系统误差
4. **信号质量下降**：某些位置可能出现信号缺失或严重失真
5. **重复性差**：不同次采集之间的可比性降低

---

### 问题3：如果水箱宽度为14厘米(水中声波传播速度=1500 m/s),计算发射信号的理论到达时间

**计算：**

已知：
- 距离 d = 14 cm = 0.14 m
- 声速 c = 1500 m/s

到达时间：
```
t = d / c
t = 0.14 m / 1500 m/s
t = 9.33 × 10⁻⁵ s
t = 93.3 μs
```

**答案：理论到达时间为 93.3 微秒**

---

### 问题4：计算为创建A-scan矩阵将要执行的N次采集的数量,已知样本直径为60毫米

**计算：**

已知：
- 样本直径 D = 60 mm
- 扫描长度 L = 60 mm (需要覆盖整个物体)
- 平移步长 Δx = 5 mm

采集数量：
```
N = L / Δx + 1
N = 60 / 5 + 1
N = 12 + 1
N = 13
```

**说明：**
- 起始位置1次 + 中间11次平移后的采集 + 最后位置1次
- 也可以理解为: N = (L / Δx) + 1 = 13次采集

**答案：需要执行 N = 13 次采集**

---

## 第2部分：读取A-scan矩阵并提取断层扫描的可观察量

### 问题5：显示A-scan矩阵及其包络(以dB表示包络)

**[数据不足 - 需要实际实验数据]**

此问题需要：
- 读取实验采集的信号文件(pos_1, pos_2, ... pos_N)
- 构建A-scan矩阵
- 计算信号包络(使用Hilbert变换或其他方法)
- 转换为dB尺度: Envelope_dB = 20*log10(abs(envelope))
- 显示矩阵图像

**Matlab实现思路：**
```matlab
% 读取所有信号并构建矩阵
% matrice_A_scan = [signal1; signal2; ...; signalN]

% 计算包络
envelope = abs(hilbert(matrice_A_scan'))';

% 转换为dB
envelope_dB = 20*log10(envelope);

% 显示
figure;
subplot(1,2,1);
imagesc(matrice_A_scan);
title('A-scan矩阵');
xlabel('时间采样点');
ylabel('采集位置');

subplot(1,2,2);
imagesc(envelope_dB);
title('包络(dB)');
xlabel('时间采样点');
ylabel('采集位置');
colorbar;
```

---

### 问题6a：提出一个可以从A-scan中的原始时间信号中表示衰减项 ∫μ(x,y)dl 的量

**理论分析：**

根据声波衰减公式：
```
A = A₀ exp(-∫_L μ(x,y) dl)
```

两边取对数：
```
ln(A) = ln(A₀) - ∫_L μ(x,y) dl
```

因此：
```
∫_L μ(x,y) dl = ln(A₀) - ln(A) = ln(A₀/A)
```

**提出的可观察量：**

对于每条A-scan线，衰减项可以表示为：

**Observable = -ln(A_received / A_reference)**

或等价地：

**Observable = -20*log10(A_received / A_reference) / (20*log10(e))**

其中：
- `A_received` 是通过物体后接收到的信号幅度
- `A_reference` 是参考幅度（无物体时的信号或信号的初始幅度A₀）

**实际实现：**
1. 提取接收信号的最大幅度或包络峰值
2. 与参考幅度（无物体情况）比较
3. 计算对数比值

**答案：可观察量为 -ln(A/A₀) 或 ln(A₀/A)，即信号幅度比值的自然对数**

---

### 问题6b：从采集的数据中提取该量,并与GS-EchoView软件提取的值(变量amp_extraites)进行比较

**[数据不足 - 需要实际实验数据]**

此问题需要：
- 实验采集的A-scan数据
- GS-EchoView计算的幅度值(amp_extraites)
- 参考信号幅度

**Matlab实现思路：**
```matlab
% 从每个A-scan信号中提取幅度
N = size(matrice_A_scan, 1);
amp_calculees = zeros(N, 1);

for i = 1:N
    signal = matrice_A_scan(i, :);
    % 方法1: 使用最大值
    amp_calculees(i) = max(abs(signal));

    % 方法2: 使用包络的最大值
    % envelope = abs(hilbert(signal));
    % amp_calculees(i) = max(envelope);
end

% 计算衰减项（如果有参考值A0）
% attenuation = -log(amp_calculees / A0);

% 或使用dB表示
amp_dB = 20*log10(amp_calculees);

% 与软件提取值比较
figure;
plot(amp_extraites, 'b-o', 'DisplayName', 'GS-EchoView');
hold on;
plot(amp_dB, 'r-x', 'DisplayName', '手动计算');
legend;
xlabel('采集位置');
ylabel('幅度 (dB)');
title('幅度对比');
grid on;

% 计算误差
erreur = amp_dB - amp_extraites;
fprintf('平均误差: %.2f dB\n', mean(erreur));
fprintf('标准差: %.2f dB\n', std(erreur));
```

---

## 第3部分：使用GS-EchoView记录幅度和进行断层扫描

### 问题7：物体完成一次完整旋转,计算将执行的R次旋转的次数

**计算：**

已知：
- 完整旋转角度 = 360°
- 角度步长 Δθ = 16.2°

旋转次数：
```
R = 360° / Δθ
R = 360 / 16.2
R = 22.22...
```

实际上应该是：
```
R = floor(360 / 16.2) = 22 次旋转
```

或者如果包含起始位置：
```
R = ceil(360 / 16.2) = 23 次采集
```

**注意：** 通常断层扫描只需要180°的数据（因为平行束几何的对称性），但这里要求完整旋转360°。

**答案：将执行 R = 22 次旋转（或23次采集，取决于是否包含起始位置）**

---

### 问题8：使用更多的角度会有什么效果？

**理论分析：**

**使用更多角度（减小角度步长）的效果：**

**正面效果：**
1. **提高角度分辨率**：更密集的投影角度提供更多的信息
2. **减少伪影**：特别是减少条纹伪影（streaking artifacts）
3. **改善图像质量**：重建图像更平滑、细节更清晰
4. **提高小结构检测能力**：能更好地重建小尺寸特征
5. **减少欠采样效应**：满足Nyquist采样定理的要求更充分

**负面影响：**
1. **增加采集时间**：更多角度意味着更长的实验时间
2. **增加数据量**：存储和处理需求增加
3. **可能增加噪声累积**：更多数据可能累积更多测量噪声

**理论依据：**
根据投影切片定理（Projection-Slice Theorem），角度采样应满足：
```
Δθ ≈ π / (N × M)
```
其中N是每个投影的采样点数，M是重建图像尺寸

**答案：使用更多角度会显著提高重建图像质量，减少伪影，改善空间分辨率，但会增加采集时间和数据量**

---

### 问题9：计算断层扫描的总测量次数

**计算：**

已知：
- 旋转次数 R = 22 次
- 每次旋转的平移步长 = 2 mm
- 扫描长度 L = 60 mm
- 每次旋转的采集次数 N = L / 2 mm + 1 = 60/2 + 1 = 31 次

总测量次数：
```
总测量次数 = R × N
总测量次数 = 22 × 31
总测量次数 = 682 次测量
```

**答案：断层扫描的总测量次数为 682 次**

---

### 问题10：评论所获得的结果

**[数据不足 - 需要实际实验结果图像]**

此问题需要观察GS-EchoView生成的断层扫描图像。

**评论应包含的方面：**

1. **图像质量评估：**
   - 图像清晰度
   - 噪声水平
   - 对比度

2. **几何准确性：**
   - 物体形状是否正确重建（应为圆形，直径60mm）
   - 是否有几何畸变

3. **伪影分析：**
   - 是否存在条纹伪影（streaking）
   - 是否有环形伪影（ring artifacts）
   - 边界效应

4. **衰减分布：**
   - 物体内部的衰减系数分布是否均匀
   - 是否能区分不同材料（如果样品有多种材料）

5. **分辨率：**
   - 空间分辨率是否足够
   - 能否分辨细节结构

**典型评论示例：**
"重建图像清晰地显示了圆柱形样品的轮廓，直径约60mm与实际相符。图像中可观察到一定程度的条纹伪影，这是由于角度采样数量有限（22个角度）造成的。物体内部的衰减分布相对均匀，边界清晰。图像质量受限于角度和平移采样密度，增加采样点可进一步改善。"

---

### 问题11：如何获得更好的断层扫描结果？

**理论分析：**

**改善断层扫描质量的方法：**

**1. 采样参数优化：**
- **增加角度数量**：减小角度步长（如使用1°或更小），从22个增加到180个或更多
- **减小平移步长**：从2mm减小到1mm或0.5mm，提高空间采样密度
- **增加时间采样率**：提高A/D转换采样频率

**2. 硬件改进：**
- 使用更高频率的换能器（提高分辨率）
- 改善换能器对齐精度
- 使用更稳定的机械平台减少振动
- 确保凝胶均匀涂抹，优化声耦合

**3. 信号处理优化：**
- **降噪处理**：对原始信号进行滤波
- **信号平均**：多次采集取平均减少随机噪声
- **自动增益控制**：补偿距离相关的衰减

**4. 重建算法改进：**
- 使用滤波反投影（FBP）而不是简单反投影
- 选择合适的滤波器（Shepp-Logan, Hamming, etc.）
- 使用迭代重建算法（如ART, SART）
- 应用正则化技术减少噪声放大

**5. 校准和补偿：**
- 进行几何校准确定精确的旋转中心
- 水衰减补偿：减去水的背景衰减
- 束硬化校正（beam hardening correction）

**6. 后处理：**
- 图像滤波和平滑
- 边缘增强
- 伪影抑制算法

**答案：主要通过增加角度和平移采样密度、使用滤波反投影算法、改善硬件精度、优化信号处理和校准等方法来提高重建质量**

---

## 第4部分：在Matlab下进行断层扫描

### 问题12：显示可观察量的矩阵

**[数据不足 - 需要实际实验数据]**

此问题需要：
- 所有角度的幅度数据已经通过lecture_tomo_etu.m读取
- 数据存储在Matrice_acqui_angle.mat中

**Matlab实现思路：**
```matlab
% 加载数据
load('Matrice_acqui_angle.mat');

% 假设数据存储在变量 sinogram 中
% sinogram矩阵维度: (平移位置数 × 角度数)
% 即 (31 × 22) 对应 (N × R)

% 显示正弦图（sinogram）
figure;
imagesc(sinogram);
colormap(gray);
colorbar;
xlabel('旋转角度索引');
ylabel('平移位置索引');
title('可观察量矩阵（正弦图）');
axis equal tight;

% 也可以显示为3D表面
figure;
surf(sinogram);
shading interp;
xlabel('角度索引');
ylabel('位置索引');
zlabel('衰减值');
title('可观察量矩阵 - 3D视图');
colorbar;

% 显示特定角度的投影
figure;
plot(sinogram(:, 1), 'LineWidth', 2);
xlabel('平移位置');
ylabel('衰减值');
title('第一个角度的投影');
grid on;
```

**说明：** 可观察量矩阵（正弦图）的每一列对应一个角度的投影，每一行对应特定平移位置在不同角度下的值。对于圆形物体，正弦图应显示出正弦波形特征。

---

### 问题13：使用Matlab中的iradon函数实现断层扫描

**[数据不足 - 需要实际实验数据进行重建]**

**Matlab实现代码：**

```matlab
%% 加载数据
load('Matrice_acqui_angle.mat');
% 假设：
% - sinogram: 可观察量矩阵 (N × R)
% - theta: 角度向量（度）

% 如果没有提供角度向量，根据已知信息创建
R = 22;  % 旋转次数
delta_theta = 16.2;  % 角度步长（度）
theta = 0:delta_theta:(R-1)*delta_theta;

%% 方法1: 简单反投影（无滤波）
fprintf('正在执行简单反投影（无滤波）...\n');
reconstruction_none = iradon(sinogram, theta, 'none', 1, size(sinogram,1));

figure('Name', '简单反投影');
imagesc(reconstruction_none);
colormap(hot);
colorbar;
axis equal tight;
title('简单反投影（无滤波）');
xlabel('X (pixels)');
ylabel('Y (pixels)');

%% 方法2: 滤波反投影 - Shepp-Logan 滤波器 + 样条插值
fprintf('正在执行滤波反投影（Shepp-Logan + 样条插值）...\n');
reconstruction_shepp = iradon(sinogram, theta, 'Shepp-Logan', 'spline', size(sinogram,1));

figure('Name', 'Shepp-Logan滤波');
imagesc(reconstruction_shepp);
colormap(hot);
colorbar;
axis equal tight;
title('滤波反投影（Shepp-Logan + 样条）');
xlabel('X (pixels)');
ylabel('Y (pixels)');

%% 方法3: 其他滤波器对比
filters = {'Ram-Lak', 'Hamming', 'Cosine', 'Hann'};
figure('Name', '不同滤波器对比');
for i = 1:length(filters)
    reconstruction = iradon(sinogram, theta, filters{i}, 'spline', size(sinogram,1));
    subplot(2, 2, i);
    imagesc(reconstruction);
    colormap(hot);
    colorbar;
    axis equal tight;
    title(['滤波器: ' filters{i}]);
end

%% 与GS-EchoView结果比较
% 加载GS-EchoView的结果图像
% gs_image = imread('gs_echoview_result.png');  % 需要根据实际文件名修改

% figure('Name', '结果对比');
% subplot(1, 2, 1);
% imagesc(reconstruction_shepp);
% colormap(hot);
% colorbar;
% title('Matlab重建 (Shepp-Logan)');
% axis equal tight;
%
% subplot(1, 2, 2);
% imshow(gs_image);
% title('GS-EchoView结果');

%% 定量分析
fprintf('\n=== 重建图像统计信息 ===\n');
fprintf('简单反投影:\n');
fprintf('  均值: %.4f\n', mean(reconstruction_none(:)));
fprintf('  标准差: %.4f\n', std(reconstruction_none(:)));
fprintf('  范围: [%.4f, %.4f]\n', min(reconstruction_none(:)), max(reconstruction_none(:)));

fprintf('\nShepp-Logan滤波:\n');
fprintf('  均值: %.4f\n', mean(reconstruction_shepp(:)));
fprintf('  标准差: %.4f\n', std(reconstruction_shepp(:)));
fprintf('  范围: [%.4f, %.4f]\n', min(reconstruction_shepp(:)), max(reconstruction_shepp(:)));

%% 保存结果
% saveas(gcf, 'reconstruction_comparison.png');
% save('reconstruction_results.mat', 'reconstruction_none', 'reconstruction_shepp');
```

**iradon函数参数说明：**

```matlab
I = iradon(R, theta, filter, interp, output_size)
```

- **R**: 正弦图（Radon变换，即投影数据矩阵）
- **theta**: 投影角度向量（度）
- **filter**: 滤波器类型
  - `'none'`: 无滤波（简单反投影）
  - `'Shepp-Logan'`: Shepp-Logan滤波器（默认）
  - `'Ram-Lak'`: Ramachandran-Lakshminarayanan滤波器
  - `'Cosine'`, `'Hamming'`, `'Hann'`: 其他窗函数
- **interp**: 插值方法
  - `'linear'`: 线性插值（默认）
  - `'spline'`: 样条插值（更平滑）
  - `'nearest'`: 最近邻插值
- **output_size**: 输出图像尺寸

**预期结果对比：**

1. **简单反投影（无滤波）：**
   - 图像模糊，有明显的星形伪影
   - 边界不清晰
   - 不适合实际应用

2. **Shepp-Logan滤波反投影：**
   - 图像清晰，边界锐利
   - 伪影显著减少
   - 与GS-EchoView结果应该相似
   - 可能由于角度采样不足仍有轻微条纹伪影

3. **与GS-EchoView对比：**
   - 如果参数设置正确，两者应高度一致
   - 差异可能来自：
     - 不同的预处理方法
     - 不同的滤波器实现
     - 数值精度差异

---

## 总结

### 完成情况统计

**可直接回答的理论/计算问题（9个）：**
1. ✓ 问题1：物体平移理由
2. ✓ 问题2：凝胶作用
3. ✓ 问题3：信号到达时间计算
4. ✓ 问题4：采集次数N计算
5. ✓ 问题6a：衰减项可观察量
6. ✓ 问题7：旋转次数R计算
7. ✓ 问题8：更多角度的效果
8. ✓ 问题9：总测量次数计算
9. ✓ 问题11：改善方法

**需要实验数据的问题（4个）：**
1. 问题5：显示A-scan矩阵 [数据不足]
2. 问题6b：提取并比较幅度 [数据不足]
3. 问题10：评论结果 [数据不足]
4. 问题12：显示可观察量矩阵 [数据不足]
5. 问题13：Matlab实现断层扫描 [数据不足 - 已提供代码框架]

### 关键概念总结

**断层扫描原理：**
- 通过多角度投影重建物体内部结构
- 基于Radon变换及其逆变换
- 测量沿路径的积分量（衰减）

**实验关键参数：**
- 样本直径：60 mm
- 水箱宽度：14 cm
- 声速：1500 m/s
- 换能器频率：2 MHz
- 平移步长：5 mm（第1部分）→ 2 mm（第3部分）
- 角度步长：16.2°
- 旋转次数：22次
- 总测量：682次

**质量改善要点：**
- 增加角度和空间采样密度
- 使用适当的滤波反投影算法
- 优化硬件对齐和信号质量
- 应用先进的重建和后处理技术

---

**本分析完成日期：** 2025-12-08
**课程：** TDSI - 超声断层扫描TP
