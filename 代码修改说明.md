# Matlab代码修改说明文档

## 修改概览

本文档详细说明了对两个Matlab代码文件的修改内容和计算过程。

### 修改的文件
1. **lecture_donnees_etu.m** - A-scan数据读取和分析（第1、2部分）
2. **lecture_tomo_etu.m** - 断层扫描数据读取和重建（第3、4部分）

---

## 文件1: lecture_donnees_etu.m

### 问题4: A-scan采集次数（已完成）

**参数：**
```matlab
Npos = 13;  % A-scan数量
```

**计算过程：**
- 样本直径：60 mm
- 扫描长度 L：60 mm
- 平移步长：5 mm
- 计算公式：N = L / 步长 + 1 = 60 / 5 + 1 = 13

**理由：**
需要13个位置来覆盖整个60mm直径的样本（起始位置 + 11次平移 + 结束位置）

---

### 问题5: 可视化A-scan矩阵及其包络

**实现功能：**
1. 计算包络的dB值
2. 显示RF信号矩阵
3. 显示包络信号矩阵（dB）
4. 显示单个位置的RF和包络信号

**关键计算：**

```matlab
% 包络转dB的公式
Matrice_acqui_env_dB = 20*log10(Matrice_acqui_env + eps);
```

**理论基础：**
- dB（分贝）是对数尺度的幅度表示
- 公式：dB = 20 × log₁₀(A)
- 使用 `eps`（机器精度）避免 log(0) 错误
- dB尺度便于显示大动态范围的信号

**可视化内容：**
- 2×2子图布局
- 热图显示整个矩阵
- 线图显示单个位置的详细信号
- 动态范围设置为60dB（典型超声成像范围）

---

### 问题6a: 计算衰减项

**理论推导：**

声波在介质中传播的衰减公式：
```
A = A₀ × exp(-∫ μ(x,y) dl)
```

对两边取自然对数：
```
ln(A) = ln(A₀) - ∫ μ(x,y) dl
```

整理得到衰减项：
```
∫ μ(x,y) dl = ln(A₀/A) = -ln(A/A₀)
```

**可观察量定义：**
- 自然对数形式：`attenuation_ln = ln(A₀/A)`
- dB形式：`attenuation_dB = 20×log₁₀(A₀/A)`

**实现代码：**

```matlab
% 1. 从每个A-scan中提取最大包络值作为接收幅度A
amp_calculees_envelope = max(Matrice_acqui_env, [], 2);

% 2. 确定参考幅度A₀（使用最大值）
A0_envelope = max(amp_calculees_envelope);

% 3. 计算衰减项（自然对数）
attenuation_ln = log(A0_envelope ./ amp_calculees_envelope);

% 4. 计算衰减项（dB）
attenuation_dB = 20*log10(A0_envelope ./ amp_calculees_envelope);
```

**物理意义：**
- `attenuation_ln`：衰减系数沿路径的积分（无量纲）
- `attenuation_dB`：以dB表示的衰减（常用于超声）
- 值越大表示信号衰减越强
- 在物体中心衰减最大，边缘衰减较小

---

### 问题6b: 与GS-EchoView对比

**对比方法：**

1. **格式转换：**
```matlab
amp_calculees_dB = 20*log10(amp_calculees_envelope);
```

2. **误差计算：**
```matlab
difference = amp_calculees_dB - amp_extraites;
erreur_moyenne = mean(abs(difference));     % 平均绝对误差
erreur_std = std(difference);                % 标准差
erreur_max = max(abs(difference));           % 最大误差
```

3. **相关性分析：**
```matlab
correlation = corrcoef(amp_extraites, amp_calculees_dB);
r = correlation(1,2);  % 相关系数
```

**可视化内容：**
- **对比曲线图**：叠加显示两组数据
- **散点图**：评估线性相关性（应接近y=x线）
- **误差分布**：柱状图显示每个位置的误差

**评估标准：**
- 平均误差 < 1 dB：非常好
- 平均误差 < 3 dB：可接受
- 相关系数 > 0.95：提取方法正确
- 相关系数 > 0.85：方法可行

**可能的误差来源：**
- 提取算法差异（峰值 vs 平均值）
- 时间窗口选择不同
- 噪声影响
- 数值精度

---

## 文件2: lecture_tomo_etu.m

### 问题7: 旋转次数计算

**计算过程：**

```matlab
% 已知参数
完整旋转角度 = 360°
角度步长 = 16.2°

% 计算旋转次数
R = 360° / 16.2° = 22.222...

% 取整
R = 22 次旋转
```

**代码实现：**
```matlab
R = 22;              % 旋转次数
delta_angle = 16.2;  % 角度步长（度）
```

**说明：**
- 完整扫描360°需要22次旋转
- 实际角度覆盖：22 × 16.2° = 356.4°
- 平行束几何理论上只需要180°，但这里进行完整360°扫描

---

### 问题9: 总测量次数（计算参考）

虽然代码中未明确实现，但这是一个重要的计算：

**计算过程：**
```
旋转次数 R = 22
每次旋转的扫描长度 L = 60 mm
平移步长 = 2 mm
每次旋转的采集次数 N = 60/2 + 1 = 31

总测量次数 = R × N = 22 × 31 = 682 次
```

---

### 问题12: 显示可观察量矩阵（正弦图）

**正弦图（Sinogram）概念：**
- 断层扫描的输入数据称为正弦图
- 每一行对应一个角度的投影
- 每一列对应一个平移位置
- 对于圆形物体，显示正弦波形特征

**实现内容：**

1. **构建角度向量：**
```matlab
theta = 0:delta_angle:(R-1)*delta_angle;
% 结果: [0°, 16.2°, 32.4°, ..., 340.2°]
```

2. **多种可视化方式：**
   - **2D热图**：`imagesc()` 彩色/灰度显示
   - **3D曲面**：`surf()` 立体显示
   - **投影曲线**：显示特定角度的一维投影
   - **角度轨迹**：显示特定位置在不同角度的值

3. **矩阵信息统计：**
```matlab
fprintf('矩阵维度: %d x %d (角度 x 位置)\n', R, Npos);
% 输出: 22 x 31
```

---

### 问题13: 断层扫描重建

**iradon函数详解：**

```matlab
obj_rec = iradon(sinogram, theta, filter, interp, output_size)
```

**参数说明：**
- `sinogram`：正弦图（每列是一个角度的投影）
- `theta`：角度向量（度）
- `filter`：滤波器类型
- `interp`：插值方法
- `output_size`：输出图像尺寸

**实现的重建方法：**

#### 方法1: 简单反投影（无滤波）
```matlab
obj_rec_none = iradon(Matrice_acqui_angle', theta, 'none', 1, output_size);
```
- **原理**：直接将投影反向投影到图像空间
- **特点**：算法简单，但图像模糊，有星形伪影
- **适用**：理解基本原理，不适合实际应用

**理论推导：**
反投影公式：
```
f(x,y) = ∫₀^π p(x·cosθ + y·sinθ, θ) dθ
```
其中 p 是投影数据。

#### 方法2: 滤波反投影 - Shepp-Logan
```matlab
obj_rec_shepp_spline = iradon(Matrice_acqui_angle', theta, 'Shepp-Logan', 'spline', output_size);
```
- **原理**：投影数据经过高通滤波后再反投影
- **Shepp-Logan滤波器**：专为医学成像设计，边缘保持好
- **样条插值**：提供更平滑的插值，减少块状伪影

**理论推导：**
滤波反投影公式：
```
f(x,y) = ∫₀^π [p(s,θ) * h(s)] dθ
```
其中 h(s) 是滤波器核，`*` 表示卷积。

**Shepp-Logan滤波器频域表示：**
```
H(ω) = |ω| × sinc(ω/2ωₘₐₓ)
```

#### 方法3-6: 其他滤波器对比
```matlab
% Ram-Lak: 理想高通滤波器（边缘锐利但噪声大）
obj_rec_ramlak = iradon(Matrice_acqui_angle', theta, 'Ram-Lak', 'spline', output_size);

% Hamming: 窗函数滤波器（平滑但分辨率降低）
obj_rec_hamming = iradon(Matrice_acqui_angle', theta, 'Hamming', 'spline', output_size);

% Cosine: 余弦窗口（折中方案）
obj_rec_cosine = iradon(Matrice_acqui_angle', theta, 'Cosine', 'spline', output_size);

% Hann: Hann窗口（类似Hamming）
obj_rec_hann = iradon(Matrice_acqui_angle', theta, 'Hann', 'spline', output_size);
```

**滤波器对比：**

| 滤波器 | 优点 | 缺点 | 适用场景 |
|--------|------|------|----------|
| 无滤波 | 简单 | 模糊、伪影多 | 理解原理 |
| Shepp-Logan | 边缘清晰、噪声抑制好 | 计算稍复杂 | 医学成像（推荐）|
| Ram-Lak | 分辨率高 | 噪声放大 | 低噪声数据 |
| Hamming | 噪声抑制强 | 分辨率降低 | 高噪声数据 |
| Cosine | 平衡 | 无特别优势 | 一般应用 |
| Hann | 类似Hamming | 同Hamming | 高噪声数据 |

**频率域滤波器公式：**

1. **Ram-Lak（理想斜坡）：**
   ```
   H(ω) = |ω|
   ```

2. **Shepp-Logan：**
   ```
   H(ω) = |ω| × sinc(ω/2ωₘₐₓ)
   ```

3. **Hamming：**
   ```
   H(ω) = |ω| × [0.54 + 0.46×cos(πω/ωₘₐₓ)]
   ```

**插值方法对比：**

- **线性插值（'linear'）：**
  - 速度快
  - 可能产生块状效应
  - 适合快速预览

- **样条插值（'spline'）：**
  - 更平滑
  - 计算量稍大
  - 推荐用于最终结果

**可视化分析：**

1. **6种方法对比**：并排显示所有重建结果
2. **无滤波vs滤波**：突出滤波的重要性
3. **差异图**：量化滤波的影响
4. **剖面对比**：1D曲线更直观地比较不同方法

---

## 重要的数学和物理概念

### 1. Radon变换

**定义：**
```
R[f](s, θ) = ∫∫ f(x,y) δ(x·cosθ + y·sinθ - s) dx dy
```

**物理意义：**
- 将2D图像转换为1D投影集合
- 积分沿直线进行（平行束几何）
- 正弦图是Radon变换的结果

### 2. 逆Radon变换

**滤波反投影公式：**
```
f(x,y) = ∫₀^π Q[p(s,θ)] |ₛ₌ₓcosθ+ysinθ dθ
```

其中 Q 是滤波操作。

### 3. 投影切片定理（Projection-Slice Theorem）

**定理：**
投影的傅里叶变换等于物体2D傅里叶变换的一个切片：
```
F₁D[p(s,θ)](ω) = F₂D[f(x,y)](ω·cosθ, ω·sinθ)
```

**意义：**
- 建立了投影空间和图像空间的关系
- 解释了为什么需要滤波（补偿1/r效应）
- 指导采样策略设计

### 4. 采样定理

**角度采样：**
```
Δθ ≤ π / N
```
其中 N 是投影中的采样点数。

**位置采样：**
```
Δs ≤ 1 / (2·fₘₐₓ)
```
满足Nyquist采样定理。

**本TP的采样：**
- 角度步长：16.2° ≈ 0.283 rad
- 位置步长：2 mm
- 采样略显不足（理想应为180个角度）

### 5. 衰减物理

**Beer-Lambert定律：**
```
I = I₀ × exp(-μ·d)
```

**在断层扫描中：**
```
A = A₀ × exp(-∫ μ(x,y) dl)
```

**可观察量：**
```
ln(A₀/A) = ∫ μ(x,y) dl
```

这正是Radon变换的形式！

---

## 预期结果和分析

### lecture_donnees_etu.m 预期输出

**问题5输出：**
- 4个子图窗口
- RF信号矩阵显示信号振荡
- 包络矩阵显示衰减趋势
- 动态范围：约40-60 dB

**问题6a输出：**
- 衰减曲线呈"U"形或"V"形
- 中间位置（穿过样本中心）衰减最大
- 边缘位置衰减最小
- 典型值：0.1 - 2.0（ln单位）或 1-20 dB

**问题6b输出：**
- 手动计算与软件提取应高度一致
- 相关系数 > 0.95
- 平均误差 < 2 dB
- 散点图接近y=x直线

### lecture_tomo_etu.m 预期输出

**问题12输出：**
- 正弦图显示条纹状图案
- 对于圆形样本，应显示正弦波形
- 矩阵尺寸：22 × 31
- 3D视图显示衰减的空间分布

**问题13输出：**

1. **无滤波重建：**
   - 可见圆形轮廓但模糊
   - 明显的星形伪影（streaking）
   - 对比度低

2. **Shepp-Logan重建：**
   - 圆形轮廓清晰
   - 边界锐利
   - 伪影显著减少
   - 内部相对均匀
   - 由于角度采样有限，仍可见轻微条纹

3. **不同滤波器对比：**
   - Ram-Lak：最锐利但噪声较大
   - Hamming：最平滑但略模糊
   - Shepp-Logan：最佳平衡

4. **剖面曲线：**
   - 无滤波：缓慢下降，底部平坦
   - 滤波：陡峭下降，平台清晰

---

## 常见问题和解决方案

### 问题1: "Undefined function or variable"

**原因：**
- 文件路径不正确
- 数据文件不存在

**解决：**
```matlab
% 检查当前目录
pwd

% 列出文件
dir *.dat

% 切换到数据目录
cd('你的数据文件夹路径')
```

### 问题2: "Error using readtable"

**原因：**
- 文件格式不匹配
- 逗号未转换为点号

**解决：**
确保 `comma2point.m` 正常工作，或手动检查 `_tmp.txt` 文件。

### 问题3: 图像重建为空或全黑

**原因：**
- 正弦图矩阵需要转置
- 角度单位错误（弧度vs度）

**解决：**
```matlab
% 确保使用转置
obj_rec = iradon(Matrice_acqui_angle', theta, ...);

% 确保角度为度（不是弧度）
theta = 0:delta_angle:(R-1)*delta_angle;  % 度
```

### 问题4: 图像质量差

**可能原因和解决：**

1. **角度采样不足：**
   - 增加旋转次数（减小角度步长）

2. **位置采样不足：**
   - 减小平移步长

3. **信号噪声：**
   - 使用更平滑的滤波器（Hamming, Hann）

4. **数据预处理：**
   - 检查衰减值范围是否合理
   - 可能需要归一化或偏移校正

---

## 运行检查清单

### 运行 lecture_donnees_etu.m 前：

- [ ] 确认在正确的工作目录
- [ ] 确认存在 pos_1.dat 到 pos_13.dat 文件
- [ ] 确认存在 A_scan_test.dat 文件
- [ ] 确认 comma2point.m 在路径中

**预期运行时间：** 5-10秒

**预期输出：**
- 3个图形窗口
- 控制台输出统计信息
- 生成 matrice_A_scan_test.mat

### 运行 lecture_tomo_etu.m 前：

- [ ] 确认存在 A_scan_1.dat 到 A_scan_22.dat 文件
- [ ] 确认 comma2point.m 在路径中

**预期运行时间：** 10-20秒

**预期输出：**
- 5个图形窗口
- 控制台输出统计和进度信息
- 生成 donnees_entree_tomo.mat
- 生成 resultats_reconstruction.mat
- 生成 reconstruction_shepp_logan.png
- 生成 reconstruction_sans_filtrage.png

---

## 进阶实验建议

### 1. 角度采样研究
修改代码测试不同角度数量的影响：
```matlab
% 测试: 11, 22, 45, 90, 180 个角度
R_values = [11, 22, 45, 90, 180];
```

### 2. 滤波器优化
自定义滤波器：
```matlab
% 创建自定义滤波器
custom_filter = @(f) abs(f) .* exp(-f.^2/cutoff^2);
```

### 3. 迭代重建
尝试代数重建技术（ART）：
```matlab
% 使用 iradon 的迭代版本
% 需要 Image Processing Toolbox
```

### 4. 噪声鲁棒性
添加噪声测试重建算法：
```matlab
% 添加高斯噪声
noisy_sinogram = Matrice_acqui_angle + randn(size(Matrice_acqui_angle)) * noise_level;
```

---

## 参考资料

### 理论基础
1. **Radon变换和逆变换**
   - Radon, J. (1917). "Über die Bestimmung von Funktionen durch ihre Integralwerte längs gewisser Mannigfaltigkeiten"

2. **滤波反投影**
   - Kak, A. C., & Slaney, M. (2001). "Principles of Computerized Tomographic Imaging"

### Matlab函数文档
- `iradon` - 逆Radon变换
- `radon` - Radon变换（可用于验证）
- `imrotate` - 图像旋转
- `interp2` - 2D插值

### 相关应用
- 医学CT成像
- 无损检测
- 地震勘探
- 天文观测

---

## 总结

### 完成的任务

**lecture_donnees_etu.m:**
- ✓ 问题4: Npos = 13
- ✓ 问题5: A-scan矩阵可视化（RF + 包络dB）
- ✓ 问题6a: 衰减项计算（ln和dB形式）
- ✓ 问题6b: 与GS-EchoView对比分析

**lecture_tomo_etu.m:**
- ✓ 问题7: R = 22 次旋转
- ✓ 问题12: 正弦图显示（2D + 3D）
- ✓ 问题13: 断层扫描重建（6种方法对比）

### 关键成果

1. **理解了超声断层扫描的完整流程**
   - 数据采集 → 信号处理 → 图像重建

2. **掌握了关键算法**
   - Radon变换
   - 滤波反投影
   - 不同滤波器的特性

3. **获得了实用技能**
   - Matlab图像处理
   - 数据可视化
   - 算法对比分析

### 学习要点

1. **物理原理**：Beer-Lambert定律和声波衰减
2. **数学工具**：Radon变换和逆变换
3. **算法实现**：滤波反投影的实现细节
4. **工程权衡**：采样密度、计算时间、图像质量的平衡

---

**文档版本：** 1.0
**最后更新：** 2025-12-08
**作者：** Claude (AI助手)
**用途：** TDSI课程 - 超声断层扫描TP
