# 代码修改快速参考

## 📋 修改总览

### ✅ lecture_donnees_etu.m (第1-2部分)

| 问题 | 内容 | 关键代码 |
|------|------|----------|
| 问题4 | A-scan数量 | `Npos = 13` (60mm÷5mm+1) |
| 问题5 | 显示矩阵和包络 | `imagesc()` + `20*log10()` |
| 问题6a | 计算衰减 | `attenuation = log(A0/A)` |
| 问题6b | 对比验证 | `corrcoef()` + 误差分析 |

### ✅ lecture_tomo_etu.m (第3-4部分)

| 问题 | 内容 | 关键代码 |
|------|------|----------|
| 问题7 | 旋转次数 | `R = 22` (360°÷16.2°) |
| 问题12 | 显示正弦图 | `imagesc()` + `surf()` |
| 问题13 | 断层扫描重建 | `iradon()` 6种方法对比 |

---

## 🔢 关键计算公式

### 衰减计算（问题6a）
```matlab
% 声波衰减: A = A₀ × exp(-∫μ dl)
% 衰减项: ∫μ dl = ln(A₀/A)

A0 = max(amp_calculees_envelope);
attenuation_ln = log(A0 ./ amp_calculees_envelope);
attenuation_dB = 20*log10(A0 ./ amp_calculees_envelope);
```

### 旋转次数（问题7）
```
R = 360° / 16.2° = 22.22 ≈ 22 次
```

### 总测量次数（问题9）
```
总数 = 旋转次数 × 每次位置数
     = 22 × 31 = 682 次
```

---

## 🎨 可视化输出

### lecture_donnees_etu.m 输出
- **图1**: 4子图 - RF矩阵、包络dB、单个RF、单个包络
- **图2**: 2子图 - 衰减曲线（ln和dB）
- **图3**: 3子图 - 幅度对比、散点图、误差分布

### lecture_tomo_etu.m 输出
- **图1**: 4子图 - 正弦图热图、灰度图、0°投影、中心轨迹
- **图2**: 3D正弦图曲面
- **图3**: 6子图 - 6种重建方法对比
- **图4**: 3子图 - 无滤波vs滤波对比
- **图5**: 2子图 - 水平和垂直剖面对比

---

## 🚀 运行指南

### 步骤1: 运行 lecture_donnees_etu.m
```matlab
% 1. 切换到数据目录
cd('你的数据文件夹路径')

% 2. 确认文件存在
dir pos_*.dat
dir A_scan_test.dat

% 3. 运行脚本
lecture_donnees_etu

% 4. 查看输出
% - 3个图形窗口
% - 控制台统计信息
% - matrice_A_scan_test.mat
```

### 步骤2: 运行 lecture_tomo_etu.m
```matlab
% 1. 确认文件存在
dir A_scan_*.dat

% 2. 运行脚本
lecture_tomo_etu

% 3. 查看输出
% - 5个图形窗口
% - resultats_reconstruction.mat
% - reconstruction_shepp_logan.png
% - reconstruction_sans_filtrage.png
```

---

## 📊 预期结果

### 问题6b: 对比结果
- ✅ 相关系数 > 0.95 → 优秀
- ✅ 平均误差 < 2 dB → 良好
- ⚠️ 误差 > 5 dB → 检查算法

### 问题13: 重建质量
- **无滤波**: 模糊，星形伪影明显
- **Shepp-Logan**: 清晰，伪影少（推荐）
- **Ram-Lak**: 最锐利，但噪声大
- **Hamming**: 最平滑，但略模糊

---

## 🔧 iradon函数用法

```matlab
obj_rec = iradon(sinogram, theta, filter, interp, output_size)
```

### 滤波器选项
- `'none'` - 无滤波（简单反投影）
- `'Shepp-Logan'` - 医学成像推荐 ⭐
- `'Ram-Lak'` - 最锐利
- `'Hamming'` - 最平滑
- `'Cosine'` - 折中
- `'Hann'` - 类似Hamming

### 插值选项
- `'linear'` - 线性插值（快速）
- `'spline'` - 样条插值（平滑）⭐
- `'nearest'` - 最近邻（粗糙）

---

## 🐛 常见问题

### 问题: "文件不存在"
**解决:**
```matlab
pwd  % 检查当前目录
cd('正确路径')
```

### 问题: "矩阵维度不匹配"
**解决:**
```matlab
% iradon需要转置矩阵
obj_rec = iradon(Matrice_acqui_angle', theta, ...)
                                    % ↑ 注意这个转置符号
```

### 问题: "图像全黑"
**解决:**
```matlab
% 检查数据范围
fprintf('数据范围: [%.2f, %.2f]\n', ...
    min(Matrice_acqui_angle(:)), max(Matrice_acqui_angle(:)));

% 调整显示范围
imagesc(obj_rec);
caxis([min_val max_val]);
```

---

## 📝 关键变量说明

### lecture_donnees_etu.m
```matlab
Npos = 13                      % A-scan数量
Nt = 时间采样点数              % 约几千个点
vecteur_temps                  % 时间向量（μs）
Matrice_acqui_rf [13 × Nt]    % RF信号矩阵
Matrice_acqui_env [13 × Nt]   % 包络信号矩阵
amp_extraites [13 × 1]         % Gampt提取幅度
```

### lecture_tomo_etu.m
```matlab
R = 22                              % 旋转次数
Npos = 31                           % 每次旋转的位置数
theta [1 × 22]                      % 角度向量（度）
Matrice_acqui_angle [22 × 31]      % 正弦图
obj_rec_shepp_spline [31 × 31]     % 重建图像
```

---

## 🎯 评分要点

### 代码完整性 (30%)
- ✅ 所有待完成部分已实现
- ✅ 代码有详细注释
- ✅ 变量命名规范

### 结果正确性 (40%)
- ✅ 图像显示正常
- ✅ 计算结果合理
- ✅ 与GS-EchoView对比一致

### 分析深度 (30%)
- ✅ 理解物理原理
- ✅ 解释算法差异
- ✅ 评论结果质量

---

## 📚 理论要点

### 1. Radon变换
```
R[f](s,θ) = ∫∫ f(x,y) δ(x·cosθ + y·sinθ - s) dx dy
```
将2D图像转为1D投影集合

### 2. 滤波反投影
```
f(x,y) = ∫₀^π [p(s,θ) * h(s)]|ₛ₌ₓcosθ+ysinθ dθ
```
投影经过滤波后反投影重建图像

### 3. Beer-Lambert定律
```
A = A₀ × exp(-∫ μ(x,y) dl)
ln(A₀/A) = ∫ μ(x,y) dl  ← 这是Radon变换！
```

---

## 💡 提示

1. **先运行 lecture_donnees_etu.m**，理解数据格式
2. **观察正弦图**（问题12），看是否有圆形物体的正弦波形
3. **对比不同滤波器**，理解各自特点
4. **截图保存结果**，用于报告
5. **记录所有参数**，便于重现结果

---

## ✨ 改进建议（选做）

### 提高图像质量
```matlab
% 增加角度采样
R = 45;  % 从22增加到45
delta_angle = 8.0;  % 角度步长减半

% 减小平移步长
% 从2mm改为1mm（数据采集时设置）
```

### 添加定量评估
```matlab
% 计算信噪比
SNR = 20*log10(mean(signal)/std(noise));

% 计算均方根误差（与理论模型对比）
RMSE = sqrt(mean((obj_rec - obj_ideal).^2));
```

---

**快速参考版本:** 1.0
**对应详细文档:** 代码修改说明.md
**TP主题:** 超声断层扫描
**课程:** TDSI
